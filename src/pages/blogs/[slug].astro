---
import PortableText from "@/components/PortableText.astro";
import { sanityClient } from "sanity:client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import Layout from "@/layouts/main.astro";

const { slug } = Astro.params;

// Type definitions based on Sanity schema
type Author = {
  _id: string;
  name: string;
  title: string;
  portrait?: {
    asset: {
      url: string;
    };
  };
  bio?: string;
  website?: {
    current: string;
  };
};

type CallToAction = {
  label: string;
  url: {
    current: string;
  };
  openInNewTab?: boolean;
};

type Blog = {
  _id: string;
  title: string;
  slug: {
    current: string;
  };
  date: string;
  image?: {
    asset: {
      url: string;
    };
    alt?: string;
  };
  author: Author;
  content: any[];
  callToAction?: CallToAction;
};

export const getStaticPaths = async () => {
  const blogs = await sanityClient.fetch<{ slug: { current: string } }[]>(
    `*[_type == "blog" && defined(slug)] | order(date desc)`
  );
  return blogs.map((blog) => ({
    params: { slug: blog.slug.current },
  }));
};

const blog = await sanityClient.fetch<Blog>(
  `*[_type == "blog" && slug.current == "${slug}"][0] {
    _id,
    title,
    slug,
    date,
    image {
      asset->{url},
      alt
    },
    author->{
      _id,
      name,
      title,
      portrait {
        asset->{url}
      },
      bio,
      website
    },
    content,
    callToAction
  }`
);

if (!blog) {
  return Astro.redirect("/404");
}

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

const formatReadingTime = (content: any[]) => {
  // Rough estimate: 200 words per minute
  const text = JSON.stringify(content);
  const wordCount = text.split(/\s+/).length;
  const readingTime = Math.max(1, Math.ceil(wordCount / 200));
  return `${readingTime} min read`;
};
---

<Layout content={{ title: blog.title }}>
  <div class="min-h-screen bg-background">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <!-- Back to blogs -->
      <div class="mb-8">
        <a
          href="/blogs"
          class="inline-flex items-center gap-2 text-foreground/60 hover:text-foreground transition-colors duration-200 text-sm"
        >
          ← Back to all posts
        </a>
      </div>

      <article class="prose prose-lg max-w-none">
        <!-- Header -->
        <header class="mb-12">
          <div class="flex items-center gap-4 mb-6">
            <Badge variant="neutral" className="text-sm">
              {formatDate(blog.date)}
            </Badge>
            <span class="text-foreground/60 text-sm">
              {formatReadingTime(blog.content)}
            </span>
          </div>

          <h1
            class="text-4xl md:text-5xl font-heading text-foreground mb-8 leading-tight"
          >
            {blog.title}
          </h1>

          <!-- Author info -->
          <div
            class="flex items-center gap-4 p-6 bg-secondary-background rounded-base border-2 border-border"
          >
            {
              blog.author.portrait && (
                <img
                  src={blog.author.portrait.asset.url}
                  alt={blog.author.name}
                  class="w-16 h-16 rounded-full object-cover border-2 border-border"
                />
              )
            }
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <h3 class="font-medium text-foreground text-lg">
                  {blog.author.name}
                </h3>
                {
                  blog.author.website && (
                    <a
                      href={blog.author.website.current}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-main hover:underline text-sm"
                    >
                      Website ↗
                    </a>
                  )
                }
              </div>
              <p class="text-foreground/60 text-sm mb-2">
                {blog.author.title}
              </p>
              {
                blog.author.bio && (
                  <p class="text-foreground/80 text-sm">{blog.author.bio}</p>
                )
              }
            </div>
          </div>
        </header>

        <!-- Featured image -->
        {
          blog.image && (
            <div class="mb-12">
              <img
                src={blog.image.asset.url}
                alt={blog.image.alt || blog.title}
                class="w-full h-auto rounded-base border-2 border-border shadow-shadow"
              />
            </div>
          )
        }

        <!-- Content -->
        <div
          class="prose prose-lg max-w-none text-foreground [&>*]:text-foreground [&>h1]:text-foreground [&>h2]:text-foreground [&>h3]:text-foreground [&>h4]:text-foreground [&>h5]:text-foreground [&>h6]:text-foreground [&>p]:text-foreground [&>li]:text-foreground [&>blockquote]:text-foreground/80 [&>blockquote]:border-l-main [&>code]:text-main [&>pre]:bg-secondary-background [&>pre]:border-2 [&>pre]:border-border"
        >
          <PortableText value={blog.content} />
        </div>
      </article>

      <!-- Call to Action -->
      {
        blog.callToAction && (
          <div class="mt-16 p-8 bg-main/10 rounded-base border-2 border-border text-center">
            <h2 class="text-2xl font-heading text-foreground mb-4">
              Ready to take action?
            </h2>
            <p class="text-foreground/70 mb-6 max-w-md mx-auto">
              Don't let this opportunity pass you by. Take the next step today.
            </p>
            <a
              href={blog.callToAction.url.current}
              target={blog.callToAction.openInNewTab ? "_blank" : "_self"}
              rel={blog.callToAction.openInNewTab ? "noopener noreferrer" : ""}
              class="inline-block px-8 py-3 bg-main text-main-foreground rounded-base border-2 border-border font-medium hover:shadow-shadow transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-ring"
            >
              {blog.callToAction.label}
              {blog.callToAction.openInNewTab && " ↗"}
            </a>
          </div>
        )
      }

      <!-- Newsletter signup -->
      <div
        class="mt-16 p-8 bg-secondary-background rounded-base border-2 border-border text-center"
      >
        <h2 class="text-2xl font-heading text-foreground mb-4">
          Enjoyed this post?
        </h2>
        <p class="text-foreground/70 mb-6 max-w-md mx-auto">
          Subscribe to get notified when new posts are published. No spam, just
          quality content.
        </p>
        <div
          class="flex flex-col sm:flex-row gap-4 justify-center items-center max-w-md mx-auto"
        >
          <input
            type="email"
            placeholder="Enter your email"
            class="flex-1 px-4 py-2 rounded-base border-2 border-border bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-ring"
          />
          <button
            class="px-6 py-2 bg-main text-main-foreground rounded-base border-2 border-border font-medium hover:shadow-shadow transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-ring whitespace-nowrap"
          >
            Subscribe
          </button>
        </div>
      </div>

      <!-- Related posts section -->
      <div class="mt-16 pt-12 border-t-2 border-border">
        <h2 class="text-2xl font-heading text-foreground mb-8 text-center">
          More Posts
        </h2>
        <div class="text-center">
          <a
            href="/blogs"
            class="inline-flex items-center gap-2 px-6 py-3 bg-secondary-background text-foreground rounded-base border-2 border-border font-medium hover:shadow-shadow transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-ring"
          >
            View All Posts →
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>
